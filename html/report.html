<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reports - Grande.</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="css/report.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script src="../js/report-pdf-export.js" defer></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
</head>
<body>
    <div class="dashboard">
        <div class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <button class="sidebar-toggle" id="sidebarToggle"><i class="fas fa-bars"></i></button>
                <h2>Grande.</h2>
            </div>
            <div class="nav-items">
                <a href="dashboard.html" class="nav-item"><i class="fas fa-chart-line"></i><span>Dashboard</span></a>
                <a href="employees.html" class="nav-item"><i class="fas fa-users"></i><span>Employees</span></a>
                <a href="attendance.html" class="nav-item"><i class="fas fa-clock"></i><span>Attendance</span></a>
                <a href="biometric.html" class="nav-item"><i class="fas fa-fingerprint"></i><span>Biometric</span></a>
                <a href="payroll.html" class="nav-item"><i class="fas fa-money-bill-wave"></i><span>Payroll</span></a>
                <a href="report.html" class="nav-item active"><i class="fas fa-file-alt"></i><span>Report</span></a>
                <a href="settings.html" class="nav-item"><i class="fas fa-cog"></i><span>Settings</span></a>
            </div>
        </div>

        <div class="main-content" id="mainContent">
            <div class="header">
                <div class="search-container">
                    <i class="fas fa-search search-icon"></i>
                    <input type="text" placeholder="Search reports..." class="search-input">
                </div>
                <div class="user-profile">
                    <span>Avery Libran</span>
                    <div style="width: 40px; height: 40px; background-color: #ddd; border-radius: 50%;"></div>
                </div>
            </div>

            <div class="report-controls">
                <div class="control-row">
                    <div class="control-group">
                        <label>Report Type</label>
                        <select id="reportType">
                            <option value="overview">Overview</option>
                            <option value="attendance">Attendance Report</option>
                            <option value="payroll">Payroll Report</option>
                            <option value="department">Department Analysis</option>
                        </select>
                    </div>
                    <div class="control-group">
                        <label>Start Date</label>
                        <input type="date" id="startDate">
                    </div>
                    <div class="control-group">
                        <label>End Date</label>
                        <input type="date" id="endDate">
                    </div>
                    <button class="btn-generate" onclick="generateReport()"><i class="fas fa-sync-alt"></i> Generate</button>
                    <button class="btn-export" onclick="exportReportToPDF()"><i class="fas fa-file-pdf"></i> Export to PDF</button>
                </div>
            </div>

            <div class="stats-overview">
                <div class="stat-card"><div class="stat-icon primary"><i class="fas fa-users"></i></div><div class="stat-info"><h3 id="totalEmployees">0</h3><p>Total Employees</p></div></div>
                <div class="stat-card"><div class="stat-icon success"><i class="fas fa-check-circle"></i></div><div class="stat-info"><h3 id="avgAttendance">0%</h3><p>Avg. Attendance</p></div></div>
                <div class="stat-card"><div class="stat-icon warning"><i class="fas fa-money-bill-wave"></i></div><div class="stat-info"><h3 id="totalPayroll">₱0.00</h3><p>Total Net Payroll</p></div></div>
                <div class="stat-card"><div class="stat-icon info"><i class="fas fa-clock"></i></div><div class="stat-info"><h3 id="totalOvertime">₱0.00</h3><p>Total Overtime Pay</p></div></div>
                <div class="stat-card"><div class="stat-icon danger"><i class="fas fa-exclamation-triangle"></i></div><div class="stat-info"><h3 id="totalDeductions">₱0.00</h3><p>Total Deductions</p></div></div>
            </div>

            <div class="charts-grid">
                <div class="chart-card"><div class="chart-title">Attendance Trend</div><div class="chart-container"><canvas id="attendanceChart"></canvas></div></div>
                <div class="chart-card"><div class="chart-title">Department Distribution</div><div class="chart-container"><canvas id="payrollChart"></canvas></div></div>
                <div class="chart-card"><div class="chart-title">Status Breakdown</div><div class="chart-container"><canvas id="statusChart"></canvas></div></div>
                <div class="chart-card"><div class="chart-title">Payroll Components</div><div class="chart-container"><canvas id="componentsChart"></canvas></div></div>
            </div>

            <div class="report-section" id="attendanceSection">
                <div class="section-title"><i class="fas fa-clock"></i> Attendance Summary</div>
                <div class="table-container">
                    <table><thead><tr><th>ID</th><th>Name</th><th>Department</th><th class="text-right">Present</th><th class="text-right">Late</th><th class="text-right">Absent</th><th class="text-right">Total</th><th class="text-right">%</th></tr></thead><tbody id="attendanceBody"></tbody></table>
                </div>
            </div>

            <div class="report-section" id="payrollSection">
                <div class="section-title"><i class="fas fa-money-bill-wave"></i> Payroll Summary</div>
                <div class="payroll-overview">
                    <div class="payroll-card"><div class="payroll-label">Basic Salary</div><div class="payroll-value" id="totalBasic">₱0.00</div></div>
                    <div class="payroll-card"><div class="payroll-label">Overtime</div><div class="payroll-value success" id="totalOT">₱0.00</div></div>
                    <div class="payroll-card"><div class="payroll-label">Gross Pay</div><div class="payroll-value primary" id="totalGross">₱0.00</div></div>
                    <div class="payroll-card"><div class="payroll-label">Deductions</div><div class="payroll-value danger" id="totalDed">₱0.00</div></div>
                    <div class="payroll-card highlight"><div class="payroll-label">Net Pay</div><div class="payroll-value" id="totalNet">₱0.00</div></div>
                    <div class="payroll-card"><div class="payroll-label">Average</div><div class="payroll-value" id="avgSal">₱0.00</div></div>
                </div>
                <div class="table-container">
                    <table><thead><tr><th>ID</th><th>Name</th><th>Position</th><th>Dept</th><th class="text-right">Basic</th><th class="text-right">OT</th><th class="text-right">Gross</th><th class="text-right">Ded.</th><th class="text-right">Net</th></tr></thead><tbody id="payrollBody"></tbody></table>
                </div>
            </div>

            <div class="report-section" id="departmentSection">
                <div class="section-title"><i class="fas fa-building"></i> Department Analysis</div>
                <div class="table-container">
                    <table><thead><tr><th>Department</th><th class="text-right">Employees</th><th class="text-right">Avg Attendance</th><th class="text-right">Total Payroll</th><th class="text-right">Avg Salary</th><th class="text-right">OT</th><th class="text-right">Ded.</th></tr></thead><tbody id="deptBody"></tbody></table>
                </div>
            </div>
        </div>
    </div>

    <button class="report-issue-btn" id="reportIssueBtn"><i class="fas fa-exclamation-circle"></i> Report Issue</button>
    <button class="logout-btn" id="logoutBtn"><i class="fas fa-sign-out-alt"></i></button>

    <div class="modal-overlay" id="issueOverlay">
        <div class="report-issue-modal">
            <div class="modal-header">
                <h2><i class="fas fa-exclamation-circle"></i> Report an Issue</h2>
                <button class="close-modal" id="closeIssue"><i class="fas fa-times"></i></button>
            </div>
            <div class="issue-form-body">
                <form id="issueForm">
                    <div class="form-group">
                        <label>Issue Type *</label>
                        <select id="issueType" required>
                            <option value="">Select Type</option>
                            <option value="Product Out of Stock">Product Out of Stock</option>
                            <option value="Equipment Malfunction">Equipment Malfunction</option>
                            <option value="System Error">System Error</option>
                            <option value="Staff Issue">Staff Issue</option>
                            <option value="Customer Complaint">Customer Complaint</option>
                            <option value="Safety Concern">Safety Concern</option>
                            <option value="Other">Other</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Title *</label>
                        <input type="text" id="issueTitle" placeholder="Brief description" required>
                    </div>
                    <div class="form-group">
                        <label>Description *</label>
                        <textarea id="issueDesc" placeholder="Provide details about the issue..." required></textarea>
                    </div>
                    <div class="form-group">
                        <label>Priority *</label>
                        <div class="issue-priority">
                            <div class="priority-option low" data-priority="low"><i class="fas fa-circle"></i> Low</div>
                            <div class="priority-option medium selected" data-priority="medium"><i class="fas fa-circle"></i> Medium</div>
                            <div class="priority-option high" data-priority="high"><i class="fas fa-circle"></i> High</div>
                        </div>
                        <input type="hidden" id="issuePriority" value="medium">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn-cancel" id="cancelIssue">Cancel</button>
                <button type="button" class="btn-submit" id="submitIssue">Submit Issue</button>
            </div>
        </div>
    </div>

    <script>
        let charts = {};

        function addAuditEntry(type, action, details, icon) {
            const data = JSON.parse(localStorage.getItem('auditTrail') || '[]');
            data.unshift({
                id: Date.now(),
                type, action, details, icon,
                user: 'Avery Libran',
                timestamp: new Date().toISOString()
            });
            localStorage.setItem('auditTrail', JSON.stringify(data));
        }

        function loadData() {
            return {
                employees: JSON.parse(localStorage.getItem('employees') || '[]'),
                attendance: JSON.parse(localStorage.getItem('attendanceRecords') || '[]'),
                payroll: JSON.parse(localStorage.getItem('payrollData') || '[]')
            };
        }

        function formatCurrency(amt) {
            return '₱' + amt.toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ',');
        }

        function filterByDate(records, dateField) {
            const start = document.getElementById('startDate').value;
            const end = document.getElementById('endDate').value;
            
            if (!start && !end) return records;
            
            return records.filter(r => {
                const date = r[dateField] || r.date || r.timestamp;
                if (!date) return true;
                
                const recordDate = new Date(date).toISOString().split('T')[0];
                if (start && recordDate < start) return false;
                if (end && recordDate > end) return false;
                return true;
            });
        }

        function destroyCharts() {
            Object.values(charts).forEach(chart => {
                if (chart) chart.destroy();
            });
            charts = {};
        }

        function generateReport() {
            destroyCharts();
            
            const {employees, attendance, payroll} = loadData();
            const filteredAttendance = filterByDate(attendance, 'date');
            const filteredPayroll = filterByDate(payroll, 'date');
            
            document.getElementById('totalEmployees').textContent = employees.length;
            
            const presentCount = filteredAttendance.filter(a => a.status === 'Present' || a.status === 'Late').length;
            const avgAtt = filteredAttendance.length > 0 ? ((presentCount / filteredAttendance.length) * 100).toFixed(1) : 0;
            document.getElementById('avgAttendance').textContent = avgAtt + '%';
            
            let totalNet = 0, totalOT = 0, totalDed = 0;
            filteredPayroll.forEach(e => {
                const ot = (e.overtimeHours || 0) * (e.overtimeRate || 0);
                const gross = (e.basicSalary || 0) + ot;
                const ded = (e.lateDeductions || 0) + (e.otherDeductions || 0);
                totalNet += gross - ded;
                totalOT += ot;
                totalDed += ded;
            });
            
            document.getElementById('totalPayroll').textContent = formatCurrency(totalNet);
            document.getElementById('totalOvertime').textContent = formatCurrency(totalOT);
            document.getElementById('totalDeductions').textContent = formatCurrency(totalDed);

            const attBody = document.getElementById('attendanceBody');
            attBody.innerHTML = employees.map(emp => {
                const empAtt = filteredAttendance.filter(a => a.employeeId === emp.id);
                const present = empAtt.filter(a => a.status === 'Present').length;
                const late = empAtt.filter(a => a.status === 'Late').length;
                const absent = empAtt.filter(a => a.status === 'Absent').length;
                const total = empAtt.length;
                const pct = total > 0 ? (((present + late) / total) * 100).toFixed(1) : 0;
                return `<tr><td>${emp.id}</td><td>${emp.name}</td><td>${emp.department || 'N/A'}</td><td class="text-right">${present}</td><td class="text-right">${late}</td><td class="text-right">${absent}</td><td class="text-right">${total}</td><td class="text-right">${pct}%</td></tr>`;
            }).join('');

            let totBasic = 0, totOTpay = 0, totGross = 0, totDedAmt = 0, totNetPay = 0;
            const payBody = document.getElementById('payrollBody');
            payBody.innerHTML = filteredPayroll.map(e => {
                const basic = e.basicSalary || 0;
                const ot = (e.overtimeHours || 0) * (e.overtimeRate || 0);
                const gross = basic + ot;
                const ded = (e.lateDeductions || 0) + (e.otherDeductions || 0);
                const net = gross - ded;
                totBasic += basic;
                totOTpay += ot;
                totGross += gross;
                totDedAmt += ded;
                totNetPay += net;
                return `<tr><td>${e.id}</td><td>${e.name}</td><td>${e.position}</td><td>${e.department || 'N/A'}</td><td class="text-right">${formatCurrency(basic)}</td><td class="text-right">${formatCurrency(ot)}</td><td class="text-right">${formatCurrency(gross)}</td><td class="text-right">${formatCurrency(ded)}</td><td class="text-right"><strong>${formatCurrency(net)}</strong></td></tr>`;
            }).join('');
            
            document.getElementById('totalBasic').textContent = formatCurrency(totBasic);
            document.getElementById('totalOT').textContent = formatCurrency(totOTpay);
            document.getElementById('totalGross').textContent = formatCurrency(totGross);
            document.getElementById('totalDed').textContent = formatCurrency(totDedAmt);
            document.getElementById('totalNet').textContent = formatCurrency(totNetPay);
            document.getElementById('avgSal').textContent = filteredPayroll.length > 0 ? formatCurrency(totNetPay / filteredPayroll.length) : '₱0.00';

            const depts = {};
            employees.forEach(e => {
                const d = e.department || 'N/A';
                if (!depts[d]) depts[d] = {emps: [], att: [], pay: []};
                depts[d].emps.push(e);
            });
            
            const deptBody = document.getElementById('deptBody');
            deptBody.innerHTML = Object.keys(depts).map(d => {
                const empIds = depts[d].emps.map(e => e.id);
                const dAtt = filteredAttendance.filter(a => empIds.includes(a.employeeId));
                const dPres = dAtt.filter(a => a.status === 'Present' || a.status === 'Late').length;
                const avgAtt = dAtt.length > 0 ? ((dPres / dAtt.length) * 100).toFixed(1) : 0;
                const dPay = filteredPayroll.filter(p => empIds.includes(p.id));
                let dTotal = 0, dOT = 0, dDed = 0;
                dPay.forEach(p => {
                    const ot = (p.overtimeHours || 0) * (p.overtimeRate || 0);
                    const gross = (p.basicSalary || 0) + ot;
                    const ded = (p.lateDeductions || 0) + (p.otherDeductions || 0);
                    dTotal += gross - ded;
                    dOT += ot;
                    dDed += ded;
                });
                const avgSal = depts[d].emps.length > 0 ? dTotal / depts[d].emps.length : 0;
                return `<tr><td><strong>${d}</strong></td><td class="text-right">${depts[d].emps.length}</td><td class="text-right">${avgAtt}%</td><td class="text-right">${formatCurrency(dTotal)}</td><td class="text-right">${formatCurrency(avgSal)}</td><td class="text-right">${formatCurrency(dOT)}</td><td class="text-right">${formatCurrency(dDed)}</td></tr>`;
            }).join('');

            const attDates = [...new Set(filteredAttendance.map(a => a.date))].sort().slice(-7);
            const attCounts = attDates.map(date => filteredAttendance.filter(a => a.date === date && (a.status === 'Present' || a.status === 'Late')).length);
            
            const ctx1 = document.getElementById('attendanceChart').getContext('2d');
            charts.attendance = new Chart(ctx1, {
                type: 'line',
                data: {
                    labels: attDates.length > 0 ? attDates : ['Day 1','Day 2','Day 3','Day 4','Day 5','Day 6','Day 7'],
                    datasets: [{
                        label: 'Present',
                        data: attCounts.length > 0 ? attCounts : [12,15,13,14,16,15,14],
                        borderColor: '#4CAF50',
                        backgroundColor: 'rgba(76, 175, 80, 0.1)',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: true }
                    }
                }
            });
            
            const deptNames = Object.keys(depts);
            const deptCounts = deptNames.map(d => depts[d].emps.length);
            const ctx2 = document.getElementById('payrollChart').getContext('2d');
            charts.payroll = new Chart(ctx2, {
                type: 'doughnut',
                data: {
                    labels: deptNames,
                    datasets: [{
                        data: deptCounts,
                        backgroundColor: ['#4CAF50','#2196F3','#ff9800','#9c27b0','#f44336']
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'bottom' }
                    }
                }
            });
            
            const statusPresent = filteredAttendance.filter(a => a.status === 'Present').length;
            const statusLate = filteredAttendance.filter(a => a.status === 'Late').length;
            const statusAbsent = filteredAttendance.filter(a => a.status === 'Absent').length;
            
            const ctx3 = document.getElementById('statusChart').getContext('2d');
            charts.status = new Chart(ctx3, {
                type: 'pie',
                data: {
                    labels: ['Present','Late','Absent'],
                    datasets: [{
                        data: [statusPresent, statusLate, statusAbsent],
                        backgroundColor: ['#4CAF50','#ff9800','#f44336']
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'bottom' }
                    }
                }
            });
            
            const ctx4 = document.getElementById('componentsChart').getContext('2d');
            charts.components = new Chart(ctx4, {
                type: 'bar',
                data: {
                    labels: ['Basic Salary','Overtime','Deductions','Net Pay'],
                    datasets: [{
                        label: 'Amount (₱)',
                        data: [totBasic, totOTpay, totDedAmt, totNetPay],
                        backgroundColor: ['#2196F3','#4CAF50','#f44336','#ff9800']
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        y: { beginAtZero: true }
                    }
                }
            });
            
            addAuditEntry('system', 'Report Generated', `Generated ${document.getElementById('reportType').value} report for ${document.getElementById('startDate').value || 'all dates'} to ${document.getElementById('endDate').value || 'present'}`, 'fa-file-alt');
        }

        document.getElementById('reportIssueBtn').addEventListener('click', () => {
            document.getElementById('issueOverlay').classList.add('active');
        });
        document.getElementById('closeIssue').addEventListener('click', () => {
            document.getElementById('issueOverlay').classList.remove('active');
        });
        document.getElementById('cancelIssue').addEventListener('click', () => {
            document.getElementById('issueOverlay').classList.remove('active');
        });

        document.querySelectorAll('.priority-option').forEach(opt => {
            opt.addEventListener('click', function() {
                document.querySelectorAll('.priority-option').forEach(o => o.classList.remove('selected'));
                this.classList.add('selected');
                document.getElementById('issuePriority').value = this.dataset.priority;
            });
        });

        document.getElementById('submitIssue').addEventListener('click', () => {
            const form = document.getElementById('issueForm');
            if (!form.checkValidity()) {
                form.reportValidity();
                return;
            }
            const type = document.getElementById('issueType').value;
            const title = document.getElementById('issueTitle').value;
            const desc = document.getElementById('issueDesc').value;
            const priority = document.getElementById('issuePriority').value;
            
            addAuditEntry('issue', `Issue Reported: ${type}`, `${title} - ${desc} (Priority: ${priority})`, 'fa-exclamation-circle');
            
            alert('Issue reported successfully!');
            form.reset();
            document.querySelectorAll('.priority-option').forEach(o => o.classList.remove('selected'));
            document.querySelector('.priority-option.medium').classList.add('selected');
            document.getElementById('issueOverlay').classList.remove('active');
        });

        document.getElementById('sidebarToggle').addEventListener('click', () => {
            document.getElementById('sidebar').classList.toggle('collapsed');
            document.getElementById('mainContent').classList.toggle('expanded');
        });

        document.getElementById('logoutBtn').addEventListener('click', () => {
            if (confirm('Are you sure you want to logout?')) window.location.href = '../index.html';
        });

        const today = new Date();
        const thirtyDaysAgo = new Date(today);
        thirtyDaysAgo.setDate(today.getDate() - 30);
        
        document.getElementById('endDate').valueAsDate = today;
        document.getElementById('startDate').valueAsDate = thirtyDaysAgo;

        generateReport();
    </script>
</body>
</html>